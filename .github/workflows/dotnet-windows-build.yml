name: _dotnet-windows-build

on:
  workflow_call:
    inputs:
      project-or-solution:
        description: Path to .sln/.csproj
        type: string
        required: true
      dotnet-version:
        description: .NET SDK (e.g., 8.0.x)
        type: string
        default: '8.0.x'
      configuration:
        type: string
        default: 'Release'
      runtime:
        description: Publish RID
        type: string
        default: 'win-x86'
      self-contained:
        type: boolean
        default: false
      publish:
        type: boolean
        default: true
      pack:
        type: boolean
        default: false
      nuspec-path:
        description: Path to .nuspec (relative to repo root)
        type: string
        default: ''
      sign-nuget:
        description: Sign produced .nupkg via NuGet sign (requires PFX secrets)
        type: boolean
        default: false
      upload:
        type: boolean
        default: false
      test-project-or-solution:
        description: Optional test project/solution
        type: string
        default: ''
      # Only when a repo has net461 targets or props that need it
      install-framework-461:
        description: Install .NET Framework 4.6.1 targeting pack
        type: boolean
        default: false
      # Only when a repo actually needs legacy NuGet packages.config
      use-nuget-restore:
        description: Run nuget restore for packages.config projects
        type: boolean
        default: false
      # Switch to full MSBuild (good for mixed/legacy solutions)
      build-with-msbuild:
        description: Use Visual Studio MSBuild instead of dotnet build
        type: boolean
        default: false    
    outputs:
      artifact_name:
        description: Name of published app artifact (if produced)
        value: ${{ jobs.build.outputs.artifact_name }}

jobs:
  build:
    runs-on: windows-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    outputs:
      artifact_name: ${{ steps.meta.outputs.artifact_name }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs['dotnet-version'] }}

      # Install .NET Framework 4.6.1 targeting pack if requested
      - name: Install .NET Framework 4.6.1 targeting pack
        if: ${{ inputs.install-framework-461 }}
        shell: powershell
        run: choco install netfx-4.6.1-devpack -y

      # Make sure NuGet CLI is available for packages.config restore
      - name: Setup NuGet
        if: ${{ inputs.use-nuget-restore }}
        uses: NuGet/setup-nuget@v2

      # packages.config restore (puts NUnit.props etc. in ./packages)
      - name: NuGet restore (packages.config)
        if: ${{ inputs.use-nuget-restore }}
        run: nuget restore "${{ inputs['project-or-solution'] }}" -NonInteractive

      # SDK-style restore (global cache)
      - name: Restore
        run: dotnet restore "${{ inputs['project-or-solution'] }}"

       # Choose build engine
      - name: Build (MSBuild)
        if: ${{ inputs.build-with-msbuild }}
        shell: cmd
        run: |
          "%ProgramFiles(x86)%\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe" ^
            "${{ inputs['project-or-solution'] }}" /m /p:Configuration=${{ inputs.configuration }} /v:m
      - name: Build
        if: ${{ !inputs.build-with-msbuild }}
        run: dotnet build "${{ inputs['project-or-solution'] }}" -c "${{ inputs.configuration }}" --no-restore

      - name: Test
        if: ${{ inputs['test-project-or-solution'] != '' }}
        run: dotnet test "${{ inputs['test-project-or-solution'] }}" -c "${{ inputs.configuration }}" --no-build --verbosity normal

      - name: Publish
        if: ${{ inputs.publish }}
        run: >
          dotnet publish "${{ inputs['project-or-solution'] }}"
          -c "${{ inputs.configuration }}"
          -r "${{ inputs.runtime }}"
          --self-contained ${{ inputs['self-contained'] }}
          --no-build
          -o out

      - id: meta
        if: ${{ inputs.publish }}
        run: echo "artifact_name=app-${{ inputs['dotnet-version'] }}" >> $env:GITHUB_OUTPUT

      - name: Upload artifact
        if: ${{ inputs.upload }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}
          path: out

      - name: NuGet pack (.nuspec)
        if: ${{ inputs.pack && inputs['nuspec-path'] != '' }}
        shell: pwsh
        run: |
          $args = @(
          "pack", "${{ inputs['nuspec-path'] }}",
          "-OutputDirectory", "nupkg",
          "-Properties", "Configuration=${{ inputs.configuration }}",
          "-Symbols", "-SymbolPackageFormat", "snupkg"
          )
          if ("${{ inputs['package-version'] }}") {
          $args += @("-Version", "${{ inputs['package-version'] }}")
          }
          nuget @args

      # --- SIGN (author signing with PFX) ---
      - name: NuGet sign packages
        if: ${{ inputs.sign-nuget && hashFiles('nupkg/**/*.nupkg') != '' }}
        shell: pwsh
        run: |
          [IO.File]::WriteAllBytes("codesign.pfx",[Convert]::FromBase64String("${{ secrets.CODESIGN_PFX_B64 }}"))
          $env:CODESIGN_PWD = "${{ secrets.CODESIGN_PFX_PASSWORD }}"
          nuget sign "nupkg\*.nupkg" `
          -CertificatePath codesign.pfx `
          -CertificatePassword $env:CODESIGN_PWD `
          -Timestamper http://timestamp.digicert.com `
          -Overwrite
      # --- UPLOAD ---
      - name: Upload NuGet packages
        if: ${{ inputs.pack && hashFiles('nupkg/**/*.nupkg') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: nupkgs
          path: nupkg
