name: _dotnet-windows-build

on:
  workflow_call:
    inputs:
      project-or-solution:
        description: Path to .sln/.csproj
        type: string
        required: true
      dotnet-version:
        description: .NET SDK (e.g., 8.0.x)
        type: string
        default: '8.0.x'
      configuration:
        type: string
        default: 'Release'
      runtime:
        description: Publish RID
        type: string
        default: 'win-x86'
      self-contained:
        type: boolean
        default: false
      publish:
        type: boolean
        default: true
      test-project-or-solution:
        description: Optional test project/solution
        type: string
        default: ''
    outputs:
      artifact_name:
        description: Name of the build output artifact (if produced)
        value: ${{ jobs.build.outputs.artifact_name }}

jobs:
  build:
    runs-on: windows-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    outputs:
      artifact_name: ${{ steps.meta.outputs.artifact_name }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs['dotnet-version'] }}

      # Install .NET Framework 4.6.1 targeting pack if requested
      - name: Install .NET Framework 4.6.1 targeting pack
        if: ${{ inputs.install-framework-461 }}
        shell: powershell
        run: choco install netfx-4.6.1-devpack -y

      # Make sure NuGet CLI is available for packages.config restore
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore
        run: dotnet restore "${{ inputs['project-or-solution'] }}" -NonInteractive

      - name: Build
        run: dotnet build "${{ inputs['project-or-solution'] }}" -c "${{ inputs.configuration }}" --no-restore

      - name: Test
        if: ${{ inputs['test-project-or-solution'] != '' }}
        run: dotnet test "${{ inputs['test-project-or-solution'] }}" -c "${{ inputs.configuration }}" --no-build --verbosity normal

      - name: Publish
        if: ${{ inputs.publish }}
        run: >
          dotnet publish "${{ inputs['project-or-solution'] }}"
          -c "${{ inputs.configuration }}"
          -r "${{ inputs.runtime }}"
          --self-contained ${{ inputs['self-contained'] }}
          --no-build
          -o out

      - id: meta
        if: ${{ inputs.publish }}
        run: echo "artifact_name=app-${{ inputs['dotnet-version'] }}" >> $env:GITHUB_OUTPUT

      - name: Upload artifact
        if: ${{ inputs.publish }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}
          path: out
